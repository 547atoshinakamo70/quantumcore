version: '{build}'
build: off
test: off

environment:
  matrix:
    - IMG: Visual Studio 2022
    - IMG: Ubuntu2204

for:
  # ---------- WINDOWS: ZIP portable + checksums ----------
  - matrix:
      only:
        - IMG: Visual Studio 2022
    image: Visual Studio 2022

    install:
      - ps: Install-Product node 20
      - cmd: |
          if exist package.json (
            npm ci || npm install
          ) else (
            echo [warn] No package.json en la raiz
          )

    build_script:
      - ps: |
          Set-StrictMode -Version Latest
          $ErrorActionPreference = 'Stop'

          # Build si existe script
          if (Test-Path package.json) {
            $hasBuild = (npm run | Select-String -Pattern ' build') -ne $null
            if ($hasBuild) { npm run build } else { Write-Host "[info] sin script build" }
          }

          # Seleccionar carpeta de salida
          $src = "dist"
          if (-not (Test-Path $src)) { if (Test-Path "build") { $src = "build" } else { $src = "." } }

          $ver = $env:APPVEYOR_BUILD_VERSION
          $out1 = "QuantumCore-v$ver-windows.zip"
          $out2 = "QuantumCore-latest-windows.zip"

          Compress-Archive -Path (Join-Path $src '*') -DestinationPath $out1 -Force
          Copy-Item $out1 $out2 -Force

          # Checksums
          $lines = @()
          foreach ($f in @($out1,$out2)) {
            if (Test-Path $f) {
              $h=(Get-FileHash $f -Algorithm SHA256).Hash
              $lines += "$h  $f"
            }
          }
          Set-Content SHA256SUMS-windows.txt ($lines -join "`r`n") -Encoding ascii

    artifacts:
      - path: QuantumCore-v$(APPVEYOR_BUILD_VERSION)-windows.zip
      - path: QuantumCore-latest-windows.zip
      - path: SHA256SUMS-windows.txt

  # ---------- UBUNTU: .tar.gz + checksums ----------
  - matrix:
      only:
        - IMG: Ubuntu2204
    image: Ubuntu2204

    install:
      - sh: |
          set -e
          curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
          sudo apt-get install -y nodejs
          if [ -f package.json ]; then npm ci || npm install; fi

    build_script:
      - sh: |
          set -e
          if [ -f package.json ] && npm run | grep -q " build"; then npm run build; fi
          OUT=release
          mkdir -p "$OUT"
          SRC=dist
          [ -d build ] && SRC=build
          [ ! -d "$SRC" ] && SRC=.
          tar -C "$SRC" -czf "$OUT/QuantumCore-v${APPVEYOR_BUILD_VERSION}-linux.tar.gz" .
          cp "$OUT/QuantumCore-v${APPVEYOR_BUILD_VERSION}-linux.tar.gz" "$OUT/QuantumCore-latest-linux.tar.gz"
          (cd "$OUT" && (sha256sum QuantumCore-* > SHA256SUMS-linux.txt || shasum -a 256 QuantumCore-* > SHA256SUMS-linux.txt))

    artifacts:
      - path: release/**
